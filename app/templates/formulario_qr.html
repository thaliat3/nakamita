{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Asistencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/theme.css' %}">
  <link rel="stylesheet" href="{% static 'css/formulario.css' %}">
</head>
<body>
  <div class="container px-3">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-7 col-xl-6">
<div class="card p-4 text-center">
<div class="brand-bar"><span class="brand-pill"><img src="{% static 'img/logo-calidad.svg' %}" alt="Nakama">NAKAMA</span></div>
          <div class="card-body pt-0">
            <form method="POST" class="text-start needs-validation" novalidate>
              {% csrf_token %}

              <div class="mb-3">
                <label class="form-label" for="tipo_evento" data-bs-toggle="tooltip" title="Selecciona el evento a registrar">Tipo de Asistencia</label>
                <select name="tipo_evento" id="tipo_evento" class="form-select" required>
                  <option value="">-- Selecciona un tipo --</option>
                  {% for tipo in tipos_evento %}
                    <option value="{{ tipo.id_tipo }}">{{ tipo.nombre_asistencia }}</option>
                  {% endfor %}
                </select>
                <div class="invalid-feedback">Selecciona un tipo de asistencia.</div>
              </div>

              <div class="mb-3" id="descripcion_group" style="display: none;">
                <label class="form-label" for="descripcion" data-bs-toggle="tooltip" title="Cuando se requiere justificar el registro">Descripción adicional</label>
                <input type="text" id="descripcion" name="descripcion" class="form-control" maxlength="50">
                <div class="invalid-feedback">Ingresa una descripción.</div>
              </div>

              <input type="hidden" name="fingerprint" id="fingerprint_input">

              <div class="d-grid">
                <button type="submit" class="btn btn-entrar btn-lg">ENTRAR</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>

<script>
  const EMPRESA_LAT = -12.080257055918374;
  const EMPRESA_LON = -76.99778307088776;
  const RADIO_METROS = 500;

  document.addEventListener("DOMContentLoaded", function () {
    // Tooltips Bootstrap
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

    $('.select2').select2({ width: '100%' });

    const form = document.querySelector("form");
    const fingerprintInput = document.getElementById("fingerprint_input");
    const tipoSelect = document.getElementById('tipo_evento');
    const descripcionGroup = document.getElementById('descripcion_group');
    const descripcionInput = document.getElementById('descripcion');
    let fingerprintListo = false;

    // FingerprintJS
    FingerprintJS.load().then(fp => {
      fp.get().then(async result => {
        const visitorId = result.visitorId;
        fingerprintInput.value = visitorId;
        fingerprintListo = true;

        // Si el dispositivo no está vinculado todavía, redirigir a Interfaz 1 (/auto/) para vincular
        try {
          const r = await fetch('{% url "api_identificar_por_fingerprint" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fingerprint: visitorId })
          });
          const data = await r.json();
          if (!data.success) {
            window.location.href = '{% url "identificar_dispositivo" %}';
            return;
          }
        } catch (_) {
          // En caso de error de red, continuar y permitir registro manual
        }
      });
    });

    // Mostrar/ocultar campo descripción según tipo de asistencia y marcar requerido si aplica
    tipoSelect.addEventListener('change', function () {
      const textoSeleccionado = tipoSelect.options[tipoSelect.selectedIndex]?.text || '';
      const requiere = textoSeleccionado === 'Entrada por otros' || textoSeleccionado === 'Salida por otros';
      descripcionGroup.style.display = requiere ? 'block' : 'none';
      if (requiere) {
        descripcionInput?.setAttribute('required', 'required');
      } else {
        descripcionInput?.removeAttribute('required');
        if (descripcionInput) {
          descripcionInput.classList.remove('is-invalid', 'is-valid');
          descripcionInput.value = '';
        }
      }
      if (tipoSelect.value) {
        tipoSelect.classList.remove('is-invalid');
        tipoSelect.classList.add('is-valid');
      }
    });

    const validateRequired = (el) => {
      if (!el) return true;
      const v = (el.value || '').trim();
      if (!v) { el.classList.add('is-invalid'); el.classList.remove('is-valid'); return false; }
      el.classList.remove('is-invalid'); el.classList.add('is-valid'); return true;
    };

    tipoSelect.addEventListener('blur', () => validateRequired(tipoSelect));
    descripcionInput?.addEventListener('input', () => validateRequired(descripcionInput));

    // Enter para enviar
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    // Envío del formulario con validación y ubicación
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const validoTipo = validateRequired(tipoSelect);
      let validoDescripcion = true;
      const requiereDescripcion = descripcionGroup.style.display !== 'none';
      if (requiereDescripcion && descripcionInput) {
        validoDescripcion = validateRequired(descripcionInput);
      }
      if (!(validoTipo && validoDescripcion)) {
        return;
      }

      if (!navigator.geolocation) {
        alert("Tu navegador no soporta geolocalización.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        function (position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const distancia = calcularDistancia(lat, lon, EMPRESA_LAT, EMPRESA_LON);

          if (distancia > RADIO_METROS) {
            alert("Debes estar dentro del área de la empresa para registrar asistencia.");
            return;
          }

          form.submit();
        },
        function () {
          alert("No se pudo obtener tu ubicación.");
        }
      );
    });

    // Función para calcular distancia en metros entre dos coordenadas
    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371000, rad = Math.PI / 180;
      const dLat = (lat2 - lat1) * rad;
      const dLon = (lon2 - lon1) * rad;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*rad)*Math.cos(lat2*rad)*Math.sin(dLon/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }
  });
</script>

</body>
</html>
